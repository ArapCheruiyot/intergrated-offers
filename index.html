<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Keep all the same styles from before -->
    <style>
        /* ... (keep all existing styles the same) ... */
        .search-results {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-left: 4px solid #4CAF50;
        }
    </style>
</head>
<body>
    <header>
        <h1>Google Drive File Uploader</h1>
    </header>
    <main>
        <h1>Upload Files Easily</h1>
        <button id="authorize_button" class="button" style="display: none;" onclick="handleAuthClick()">Authorize Access</button>
        <button id="signout_button" class="button" style="display: none;" onclick="handleSignoutClick()">Sign Out</button>

        <div id="uploadSection">
            <!-- Keep the existing upload UI -->
            <label for="file_input">Select Excel files to upload:</label>
            <input type="file" id="file_input" multiple accept=".xlsx, .xls" onchange="handleFileSelection()">
            <ul id="file_list" class="file-list"></ul>
            <button class="button" onclick="uploadFiles()">Upload Files</button>
            <p class="notice">Note: Only Excel files (.xlsx, .xls) are allowed. You can select multiple files.</p>
            
            <!-- Enhanced Search Section -->
            <div class="search-section">
                <input type="text" id="searchInput" placeholder="Enter customer number">
                <button class="button" id="searchButton" onclick="handleSearch()">Search</button>
                <div id="searchResults" class="search-results"></div>
            </div>

            <!-- Progress bar container -->
            <div class="progress-container">
                <div id="progress_bar" class="progress-bar"></div>
            </div>
        </div>
    </main>
    <footer>
        &copy; 2025 FileUploader Inc. All rights reserved.
    </footer>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <script>
        const CLIENT_ID = '958416089916-1embl17stmkectofeqb74c54ccs38rb5.apps.googleusercontent.com';
        const API_KEY = 'YOUR_API_KEY';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FOLDER_ID = '1rSxY5C7YCGFS1mpwlAckQQuBTAn8OQH-'; // Your folder ID

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let selectedFiles = [];

        // Keep all the existing auth functions the same until...

        // Modified Search Function
        async function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div>Searching...</div>';

            if (!searchTerm) {
                resultsContainer.innerHTML = '<div class="result-item">Please enter a search term</div>';
                return;
            }

            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${FOLDER_ID}' in parents and mimeType contains 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'`,
                    fields: 'files(id, name)'
                });

                const files = response.result.files;
                if (!files.length) {
                    resultsContainer.innerHTML = '<div class="result-item">No files found in drive</div>';
                    return;
                }

                resultsContainer.innerHTML = '';
                let foundMatches = false;

                for (const file of files) {
                    try {
                        const fileResponse = await gapi.client.drive.files.get({
                            fileId: file.id,
                            alt: 'media'
                        }, { responseType: 'arraybuffer' });

                        const workbook = XLSX.read(fileResponse.body, { type: 'array' });
                        
                        workbook.SheetNames.forEach(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            
                            jsonData.forEach((row, index) => {
                                Object.values(row).forEach(value => {
                                    if (value.toString().includes(searchTerm)) {
                                        foundMatches = true;
                                        const resultHTML = `
                                            <div class="result-item">
                                                <strong>File:</strong> ${file.name}<br>
                                                <strong>Sheet:</strong> ${sheetName}<br>
                                                <strong>Row ${index + 2}:</strong> ${JSON.stringify(row)}
                                            </div>
                                        `;
                                        resultsContainer.innerHTML += resultHTML;
                                    }
                                });
                            });
                        });
                    } catch (error) {
                        console.error('Error processing file:', file.name, error);
                    }
                }

                if (!foundMatches) {
                    resultsContainer.innerHTML = `<div class="result-item">No matches found for "${searchTerm}"</div>`;
                }
            } catch (error) {
                console.error('Search failed:', error);
                resultsContainer.innerHTML = '<div class="result-item">Search failed - check console</div>';
            }
        }

        // Keep all other functions the same (handleAuthClick, uploadFiles, etc.)

        // Update the uploadFiles function to use FOLDER_ID constant
        async function uploadFiles() {
            if (!selectedFiles.length) {
                alert('Please select at least one file to upload.');
                return;
            }

            // Rest of your uploadFiles function remains the same...
            // (just make sure it's using the FOLDER_ID constant)
        }
    </script>
</body>
</html>
