<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive File Uploader and Searcher</title>
    <style>
        /* Your existing styles remain unchanged */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; color: #333; }
        header { background-color: #4CAF50; color: white; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        main { max-width: 600px; margin: 40px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .button { display: inline-block; padding: 10px 20px; margin: 10px 0; font-size: 1em; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .button:hover { background-color: #45a049; }
        #uploadSection { display: none; margin-top: 20px; }
        /* ... other styles ... */
    </style>
</head>
<body>
    <header><h1>Google Drive File Uploader and Searcher</h1></header>
    <main>
        <h1>Upload and Search Files</h1>
        <button id="authorize_button" class="button" style="display: none;">Authorize Access</button>
        <button id="signout_button" class="button" style="display: none;">Sign Out</button>

        <div id="uploadSection">
            <label for="file_input">Select Excel files to upload:</label>
            <input type="file" id="file_input" multiple accept=".xlsx, .xls">
            <ul id="file_list" class="file-list"></ul>
            <button class="button" id="uploadButton">Upload Files</button>
            <p class="notice">Note: Only Excel files (.xlsx, .xls) are allowed.</p>
            
            <input type="text" id="searchInput" placeholder="Enter customer number">
            <button id="searchButton">Search</button>
            <div class="progress-container"><div id="progress_bar" class="progress-bar"></div></div>
        </div>
    </main>
    <footer>&copy; 2025 FileUploader Inc.</footer>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <script>
        const CLIENT_ID = '743264679221-omplmhe5mj6vo37dbtk2dgj5vcfv6p4k.apps.googleusercontent.com';
        const API_KEY = 'YOUR_API_KEY'; // Replace with your API key
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive';
        const FOLDER_ID = '1rSxY5C7YCGFS1mpwlAckQQuBTAn8OQH-'; // Your folder ID

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // Debugging: Add console logs for key steps
        console.log("Initializing...");

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
                gapiInited = true;
                maybeEnableButtons();
                console.log("GAPI initialized successfully");
            } catch (error) {
                console.error("GAPI initialization failed:", error);
            }
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: ''
            });
            gisInited = true;
            maybeEnableButtons();
            console.log("GIS initialized successfully");
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').style.display = 'block';
                console.log("Auth button enabled");
            }
        }

        // Auth handlers
        document.getElementById('authorize_button').onclick = handleAuthClick;
        document.getElementById('signout_button').onclick = handleSignoutClick;

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) {
                    console.error("Auth error:", resp.error);
                    return;
                }
                console.log("Auth successful. Token:", gapi.client.getToken());
                document.getElementById('authorize_button').style.display = 'none';
                document.getElementById('signout_button').style.display = 'block';
                document.getElementById('uploadSection').style.display = 'block';
            };
            tokenClient.requestAccessToken(gapi.client.getToken() ? {prompt: ''} : {prompt: 'consent'});
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken(null);
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('signout_button').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'none';
                console.log("User signed out");
            }
        }

        // File handling
        document.getElementById('file_input').onchange = handleFileSelection;

        function handleFileSelection() {
            const files = Array.from(document.getElementById('file_input').files);
            const fileList = document.getElementById('file_list');
            fileList.innerHTML = '';
            files.forEach(file => {
                const li = document.createElement('li');
                li.textContent = file.name;
                fileList.appendChild(li);
            });
            console.log("Selected files:", files.map(f => f.name));
        }

        // Upload files
        document.getElementById('uploadButton').onclick = uploadFiles;

        async function uploadFiles() {
            const files = document.getElementById('file_input').files;
            if (!files.length) {
                alert('Please select files to upload.');
                return;
            }

            try {
                for (const file of files) {
                    const metadata = {
                        name: file.name,
                        mimeType: file.type,
                        parents: [FOLDER_ID]
                    };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                    form.append('file', file);

                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart');
                    xhr.setRequestHeader('Authorization', 'Bearer ' + gapi.client.getToken().access_token);
                    
                    xhr.upload.onprogress = e => {
                        if (e.lengthComputable) {
                            document.getElementById('progress_bar').style.width = `${(e.loaded / e.total) * 100}%`;
                        }
                    };

                    await new Promise((resolve, reject) => {
                        xhr.onload = () => (xhr.status === 200) ? resolve() : reject(xhr.statusText);
                        xhr.onerror = () => reject('Upload failed');
                        xhr.send(form);
                    });
                }
                alert('All files uploaded successfully!');
            } catch (error) {
                console.error("Upload error:", error);
                alert('Upload failed: ' + error);
            }
        }

        // Search functionality (FIXED)
        document.getElementById('searchButton').addEventListener('click', async () => {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                alert("Please enter a customer number.");
                return;
            }

            try {
                console.log("Starting search for:", searchTerm);
                
                // Get all Excel files from the folder
                const response = await gapi.client.drive.files.list({
                    q: `'${FOLDER_ID}' in parents and mimeType='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'`,
                    fields: 'files(id, name)',
                    pageSize: 100
                });

                const files = response.result.files;
                console.log("Found files:", files);

                if (!files.length) {
                    alert("No files found in the folder.");
                    return;
                }

                let found = false;
                for (const file of files) {
                    console.log("Processing file:", file.name);
                    
                    // Download file content
                    const fileResponse = await gapi.client.drive.files.get({
                        fileId: file.id,
                        alt: 'media'
                    }, { responseType: 'arraybuffer' });

                    // Parse Excel data
                    const data = new Uint8Array(fileResponse.body);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Search all sheets
                    for (const sheetName of workbook.SheetNames) {
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        for (const row of jsonData) {
                            for (const key in row) {
                                if (row[key]?.toString().includes(searchTerm)) {
                                    alert(`Found ${searchTerm} in ${file.name}, Sheet: ${sheetName}`);
                                    found = true;
                                    return;
                                }
                            }
                        }
                    }
                }

                if (!found) {
                    alert(`Customer number ${searchTerm} not found.`);
                }

            } catch (error) {
                console.error("Search failed:", error);
                alert("Search error: " + error.message);
            }
        });
    </script>
</body>
</html>
